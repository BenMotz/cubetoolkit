{% extends "base.html" %}
{% load hash_filter %}
{% load markup %}

{% block title %}
Editing {{ event_list_name }}
{% endblock %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/messages.css">
<style type="text/css">
  @import url('{{ STATIC_URL }}css/lib/smoothness/jquery-ui.css');
  .private {
  font-style: italic;
  }
  .external {
  font-weight: bold;
  }
  .discounted {
    color: #a000FF;
  }
  .cancelled {
    color: red;
  }
  h3 { font-family: Arial; }

  table { border-collapse: collapse; }
  tr:nth-child(odd) td {
      background-color: #d0d0d0;
  }
  tr:nth-child(even) td {
      background-color: #c0c0c0;
  }
  td:first-child {
      text-align: right;
      width: 100px;
      padding-right: 10px;
  }
  #controls {
      border: thick solid black;
      padding: 10px;
      float: right;
      position: absolute;
      top: 0;
      right: 10px;
  }
</style>
{% endblock %}

{% block script %}
<script type="text/javascript" src="{{ STATIC_URL }}js/lib/jquery.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/lib/jquery-ui.min.js"></script>
<script type="text/javascript">
var edit_prefs = { {% for p,v in edit_prefs.iteritems %}
    '{{ p }}' : '{{ v }}',
{% endfor %}};
$(document).ready(function() {
        // Add date picker:
        $('#id_lookahead_to').datepicker({
            dateFormat : 'dd-mm-yy',
            onSelect : dateRangeSelected,
            minDate : 0,
        });

        prefs_updated(edit_prefs);
});
function dateRangeSelected(dateText, inst) {
    var enddate = $.datepicker.parseDate('dd-mm-yy', dateText);
    var startdate = new Date({{start.year}}, {{start.month}} - 1, {{start.day}});
    // Calculate days between those two dates:
    var days_ahead = Math.ceil((enddate.getTime() - startdate.getTime())/86400000);
    if(days_ahead <= 0) {
        days_ahead = 0;
    }
    window.location.href = "{% url day-edit year=start.year day=start.day month=start.month %}?daysahead=" + days_ahead;
}
function set_edit_pref(pref, value) {
    if(edit_prefs[pref] !== value) {
        edit_prefs[pref] = value;
        $.getJSON('{% url set_edit_preferences %}', edit_prefs, prefs_updated);
    }
}
function prefs_updated(data) {
    edit_prefs = data;
    if(edit_prefs['popups'] === 'false') {
        $('#set_inline').replaceWith('<b id="set_inline">this window</b>');
        $('#set_popups').replaceWith('<a id="set_popups" href="#">pop-ups</a>');
        $('#set_popups').click(function() { set_edit_pref('popups',true); });
        // Clear click handlers on links in table
        $('table a').off('click');
    } else {
        $('#set_inline').replaceWith('<a id="set_inline" href="#">this window</a>');
        $('#set_inline').click(function() { set_edit_pref('popups',false); });
        $('#set_popups').replaceWith('<b id="set_popups">pop-ups</b>');
        // Change links in table to open in a new window:
        $('table a').click(function(e) {
            window.open(e.currentTarget.href,"edit_form","height=800,width=800,scrollbars,resizable,toolbar");
            return false;
        });
    }
}
</script>
{% endblock %}

{% block body %}
<img src="{{ STATIC_URL }}diary/diary_edit_list_header.gif" alt="Cube Microplex" width="150px">
<h3>CUBE events diary</h3>
<p id="controls"><a href="{% url logout %}">Log out</a><br>
Edit in: <a id="set_popups" href="#">pop-ups</a> | <a id="set_inline" href="#">this window</a></p>

<p><a name="top"></a></p>
<h4>Key:</h4>
<p><span class="private">Private events are in italics</span><br>
<span class="external">Outside hires are bolded</span><br>
<span class="discounted">Discounted events (like TTT) are magenta</span><br>
<span class="cancelled">Cancelled events are red</span></p>

<div class="programme"><p align='center'><a href="{% url day-edit year=start.year day=start.day month=start.month %}?daysahead=30">See 1 month</a> | 
<a href="{% url day-edit year=start.year day=start.day month=start.month %}?daysahead=60">See 2 months</a> | 
<a href="{% url day-edit year=start.year day=start.day month=start.month %}?daysahead=90">See 3 months</a></p>
<p align='center'><label for="id_start">See from now until:</label> <input type="text" name="lookahead_to" value="{{ end|date:'j-m-Y'}}" id="id_lookahead_to" /></p>

{% include "messages.html" %}

<table class="summary">
    <tr><td></td><td colspan="3"><a href="{% url add-event %}?date={{start|date:"j-m-Y"}}">New event</a></td></tr>

{% for day, showings in dates.items %}
    {% ifchanged %}<tr class="row_year"><td><h1>{{ day|date:"Y" }} </h1></td><td colspan="3"></td></tr>{% endifchanged %}
    {% ifchanged %}<tr class="row_month"><td><h2>{{ day|date:"F" }}</h2></td><td colspan="3"></td></tr></tr>
    {% endifchanged %}
    {% if day in ideas %}
    <tr><td><a href="{% url edit-ideas year=day.year month=day.month %}">IDEAS</a></td><td colspan="3">{{ ideas|lookup:day|markdown }}</td></tr>
    {% endif %}
    <tr class="row_day"><td class="cell_day"><a href="{% url add-event %}?date={{day|date:"j-m-Y"}}">{{ day|date:"D"}}&nbsp;{{ day|date:"j" }}</a></td>

    {% for showing in showings %}
    <td>
    <a href="{% url edit-showing showing_id=showing.pk %}">{{ showing.start|date:"H:i" }}</a>
    </td>
    <td class="table_gap">&nbsp;</td>
    <td>{{ showing.booked_by }} <a href="{% url edit-event-details-view pk=showing.event.pk %}">
    <span class="{% if showing.cancelled or showing.event.cancelled %}cancelled{% endif %}{% if showing.discounted %} discounted{% endif %}{% if showing.event.private %} private{% endif %}{% if showing.event.outside_hire %} external{% endif %}">
        {% if showing.confirmed %}
        {{ showing.event.name|upper }}
        {% else %}
        {{ showing.event.name }}
        {% endif %}{% if showing.discounted %}(TTT){% endif %}{% if showing.cancelled or showing.event.cancelled %}(CANCELLED){% endif %}
    </span>
    </a></td></tr>
    <tr><td>&nbsp;</td>
    {% endfor %}
    <td colspan="3">&nbsp;</td></tr>

{% endfor %}

</table>
</div>

{% endblock %}

