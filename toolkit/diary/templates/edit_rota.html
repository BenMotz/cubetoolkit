{% extends "base.html" %}

{% block title %}
CUBE role rota
{% endblock %}

{% block css %}
<style type="text/css">
    @import url('{{ STATIC_URL }}css/lib/smoothness/jquery-ui.css');
    body {font-family:Arial,Helvetica,sans-serif; }
    h1, h2 { margin: 1mm; }
    h1 { font-size: 16pt; }
    h2 { font-size: 14pt; }

    td.cell_day {
        font-weight: bold;
        text-align: right;
        color: blue;
    }
    td.event_name {
        font-weight: bold;
        color: blue;
    }
    .right {
        text-align: right;
    }
    td.rota_box {
        width: 6cm;
        height: 0.65cm;
        border-style: solid;
        border-width: 0px;
        border-color: gray;
    }
    .na {
        color: lightgray;
        cursor: pointer;
    }
    .rota_name {
        cursor: pointer;
    }
    td.event_name a, td.event_name a:visited{
        color: blue;
        text-decoration: none;
    }
    td.event_name a:hover {
        text-decoration: underline;
    }
    .showing_rota_notes {
        border-top: thin dashed lightgray;
        border-bottom: thin solid lightgray;
        width: 90%;
        font-family: monospace;
        white-space: pre-wrap;
        padding: 0.4em 1em;
        overflow: auto;
    }
</style>
{% endblock %}

{% block script %}
<script type="text/javascript" src="{{ STATIC_URL }}js/lib/jquery.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/lib/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/lib/jquery.jeditable.mini.js"></script>
<script>
function configureDatePickerControls() {
        // Add date picker:
        $('#id_from_date').datepicker({
            dateFormat : 'dd-mm-yy',
            onSelect : dateRangeSelected,
        });
        $('#id_to_date').datepicker({
            dateFormat : 'dd-mm-yy',
            onSelect : dateRangeSelected,
        });
        $('#daterange')[0].onsubmit = function() {
            dateRangeSelected();
            return false;
        }
};

function parse_date_from_control(control_id) {
    var text = $(control_id)[0].value;
    return $.datepicker.parseDate('dd-mm-yy', text);
}

function dateRangeSelected(dateText, inst) {
    var from_date = parse_date_from_control('#id_from_date');
    var to_date = parse_date_from_control('#id_to_date');
    // Calculate days between those two dates:
    var days_ahead = Math.ceil((to_date.getTime() - from_date.getTime())/86400000);
    if(days_ahead <= 0) {
        days_ahead = 0;
    }
    window.location.href = "{% url "rota-edit" %}/" +
        (from_date.getYear() + 1900) + "/" + (from_date.getMonth() + 1) + "/" +
        from_date.getDate() + "?daysahead=" + days_ahead;
}

function configureEditInPlaceControls() {
         $('.rota_name').editable('', {
            width: "5cm",
            placeholder: '{{ placeholder_text }}',
            submit: "Save",
            submitdata: {
                csrfmiddlewaretoken: "{{ csrf_token }}"
            }
         });
         var showing_id_re = /showing_rota_notes_(\d+)/;

         $('.showing_rota_notes span').each(function () {
            var showing_id;
            var element = $(this);
            var showing_id_match = showing_id_re.exec(element.attr('id'));
            if (showing_id_match) {
                showing_id = showing_id_match[1];
                element.editable('/diary/edit/showing/id/' + showing_id + '/rota_notes/', {
                    name: 'rota_notes',
                    type: 'textarea',
                    rows: 5,
                    width: '90%',
                    //placeholder: '{{ placeholder_text }}',
                    placeholder: '<span class="na">General notes (click to edit)</span>',
                    submit: 'Save',
                    submitdata: {
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    }
                 });
            }
        });
}
 $(document).ready(function() {
         configureDatePickerControls();
         configureEditInPlaceControls();
 });
</script>
{% endblock %}

{% block body %}
<form id='daterange'>
<p align='center'><label for="id_from_date">{{ event_field|capfirst }} from </label><input type="text" name="from_date" value="{{ start_date|date:'j-m-Y'}}" id="id_from_date" />
<label for="id_to_date"> to </label><input type="text" name="to_date" value="{{ end_date|date:'j-m-Y'}}" id="id_to_date" />
</p>
</form>

<table border="0" cellspacing="0">

{% for showing in showings %}
    {% ifchanged %}<tr><td><h1>{{ showing.start|date:"Y" }} </h1></td><td colspan="6"></td></tr>{% endifchanged %}
    {% ifchanged %}<tr><td></td><td><h2>{{ showing.start|date:"F" }}</h2></td><td colspan="5"></td></tr>{% endifchanged %}
    <tr>
        <td></td>
        <td class="cell_day">{{ showing.start|date:"D"}}&nbsp;{{ showing.start|date:"j" }}</td>
        <td class="cell_day">{{ showing.start|date:"H:i" }}</td><td class="event_name" colspan="4"><a href="{% url "edit-showing" showing.pk %}">{{ showing.event.name.upper }}</a></td>
    </tr>
    {% for rota_entry in showing.rotaentry_set.all %}
        {% if forloop.counter|divisibleby:2 %}
        <td class="rota_box">
        {{ rota_entry.role.name }}-{{ rota_entry.rank }} </td>
        <td class="rota_box"><span class="rota_name" id="{{ rota_entry.pk }}">{{ rota_entry.name|default:placeholder_text }}</span></td>
        </tr>
        {% else %}
        <tr>
        <td colspan="3"></td>
        <td class="rota_box">
        {{ rota_entry.role.name }}-{{ rota_entry.rank }} </td>
        <td class="rota_box"><span class="rota_name" id="{{ rota_entry.pk }}">{{ rota_entry.name|default:placeholder_text }}</span></td>
            {% if forloop.last %}
                <td colspan="2"></td></tr>
            {% endif %}
        {% endif %}
    {% endfor %}
    <tr>
        <td colspan="3"></td><td class="showing_rota_notes" colspan="4"><span id="showing_rota_notes_{{ showing.pk }}">{{ showing.rota_notes }}</span></td>
    </tr>
{% endfor %}

</table>

{% endblock %}

