#!/bin/bash
#
# Reset the django database, and run python scripts to:
#   1. Import all data from the generic toolkit_import database into the django
#      database
#   2. Assign some event tags based on semi-educated guesswork
#   3. Create default cube/admin users

set -e # Abort on errors

if [ $# -eq 0 ] ; then
	echo "Usage: $0 [Path to site root]"
	exit 1
fi

if [ ! -d $1 ] ; then
	echo "Error: $1 is not a directory"
	exit 1
fi

TOOLKIT_PATH=$1

echo "Activate virtualenv"

source $TOOLKIT_PATH/venv/bin/activate

export PYTHONPATH=$PYTHONPATH:$TOOLKIT_PATH
export DJANGO_SETTINGS_MODULE=toolkit.import_settings

echo "Resetting database"

# First syncdb, to make sure all tables that aren't managed by south (including
# south's tracking table) exist
python $TOOLKIT_PATH/manage.py syncdb --noinput
# Run south to make sure all the tables it manages have the latest migrations
# applied
python $TOOLKIT_PATH/manage.py migrate
# Now wipe out all data from the database
python $TOOLKIT_PATH/manage.py flush --noinput
# Make south reconstruct its tracking table
python $TOOLKIT_PATH/manage.py migrate --fake

echo "Importing into django"

python $TOOLKIT_PATH/import_script/import_database.py $TOOLKIT_PATH

echo "Done. Guessing event tags..."

python $TOOLKIT_PATH/import_script/auto_tag.py

echo "Creating users"

python $TOOLKIT_PATH/import_script/create_users.py

echo "Import index"
python $TOOLKIT_PATH/import_script/import_index.py $TOOLKIT_PATH/import_script/source_data/tools.dat
